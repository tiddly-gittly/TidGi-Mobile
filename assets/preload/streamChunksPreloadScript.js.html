/* eslint-disable @typescript-eslint/prefer-ts-expect-error */
/* eslint-disable @typescript-eslint/ban-ts-comment */
/* eslint-disable @typescript-eslint/strict-boolean-expressions */
/* eslint-disable unicorn/prefer-spread */
var OnStreamChunksToWebViewEventTypes;
(function (OnStreamChunksToWebViewEventTypes) {
    OnStreamChunksToWebViewEventTypes["CHECK_RECEIVER_READY"] = "CHECK_RECEIVER_READY";
    OnStreamChunksToWebViewEventTypes["TIDDLER_STORE_SCRIPT_CHUNK"] = "TIDDLER_STORE_SCRIPT_CHUNK";
    OnStreamChunksToWebViewEventTypes["TIDDLER_STORE_SCRIPT_CHUNK_END"] = "TIDDLER_STORE_SCRIPT_CHUNK_END";
    OnStreamChunksToWebViewEventTypes["TIDDLYWIKI_HTML1"] = "TIDDLYWIKI_HTML1";
    OnStreamChunksToWebViewEventTypes["TIDDLYWIKI_HTML2"] = "TIDDLYWIKI_HTML2";
})(OnStreamChunksToWebViewEventTypes || (OnStreamChunksToWebViewEventTypes = {}));
/**
 * Run `pnpm build:preload` to build this file.
 */
(function useStreamChunksToWebViewWebviewSideReceiverIIFE() {
    /**
     * Array of stringified json array.
     */
    var tiddlersStoreContents = [];
    var htmlParts = {};
    function resetUseStreamChunksToWebViewWebviewSideReceiverIIFE() {
        htmlParts = {};
        tiddlersStoreContents = [];
    }
    // @ts-ignore
    window.onStreamChunksToWebView = function (event) {
        var _a, _b, _c;
        switch (event.type) {
            case OnStreamChunksToWebViewEventTypes.TIDDLYWIKI_HTML1: {
                htmlParts.html1 = event.data;
                document.body.innerHTML = htmlParts.html1;
                break;
            }
            case OnStreamChunksToWebViewEventTypes.TIDDLYWIKI_HTML2: {
                htmlParts.html2 = event.data;
                break;
            }
            case OnStreamChunksToWebViewEventTypes.TIDDLER_STORE_SCRIPT_CHUNK: {
                tiddlersStoreContents.push(event.data);
                break;
            }
            case OnStreamChunksToWebViewEventTypes.TIDDLER_STORE_SCRIPT_CHUNK_END: {
                var startInjectTiddlerIfHTMLDone_1 = function () {
                    if (htmlParts.html1 && htmlParts.html2) {
                        startInjectHTML();
                        // setTimeout(startInjectHTML, 4000);
                    }
                    else {
                        setTimeout(startInjectTiddlerIfHTMLDone_1, 100);
                    }
                };
                startInjectTiddlerIfHTMLDone_1();
                break;
            }
            case OnStreamChunksToWebViewEventTypes.CHECK_RECEIVER_READY: {
                // @ts-ignore
                (_c = (_b = (_a = window.service) === null || _a === void 0 ? void 0 : _a.wikiHookService) === null || _b === void 0 ? void 0 : _b.setWebviewReceiverReady) === null || _c === void 0 ? void 0 : _c.call(_b);
                resetUseStreamChunksToWebViewWebviewSideReceiverIIFE();
                break;
            }
        }
    };
    function startInjectHTML() {
        console.log('startInjectHTML');
        /**
         * All information needed are collected.
         * Start using html and store.
         */
        var storeScripts = tiddlersStoreContents.map(function (storeJSONString, index) {
            return getStoreScript(storeJSONString, "tidgi-tiddlers-store-".concat(index));
        });
        // DEBUG: console storeScripts
        console.log("storeScripts", storeScripts);
        // DEBUG: console htmlParts.html1
        console.log("htmlParts.html1", htmlParts.html1);
        // DEBUG: console htmlParts.html2
        console.log("htmlParts.html2", htmlParts.html2);
        // document.write(`${htmlParts.html1}${storeScripts.join('')}${htmlParts.html2}`);
        // document.documentElement.innerHTML = `${htmlParts.html1}${storeScripts.join('')}${htmlParts.html2}`;
        document.open();
        document.write("".concat(htmlParts.html1).concat(storeScripts.join('')).concat(htmlParts.html2));
        document.close();
        resetUseStreamChunksToWebViewWebviewSideReceiverIIFE();
    }
    function getStoreScript(storeJSONString, name) {
        var tiddlersStoreScript = document.createElement('script');
        tiddlersStoreScript.type = 'application/json';
        tiddlersStoreScript.classList.add('tiddlywiki-tiddler-store', name);
        tiddlersStoreScript.textContent = storeJSONString;
        return tiddlersStoreScript.outerHTML;
    }
})();

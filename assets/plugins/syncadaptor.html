{"author":"LinOnetwo","core-version":">=5.1.22","dependents":"","description":"Save/load data to tidgi's main process","list":"readme tree","name":"TidGi","plugin-priority-comment":"use 9, lower than $:/plugins/tiddlywiki/tiddlyweb's 10, so the js load before it to register","plugin-type":"plugin","text":"{\"tiddlers\":{\"$:/plugins/linonetwo/expo-file-system-syncadaptor/readme\":{\"title\":\"$:/plugins/linonetwo/expo-file-system-syncadaptor/readme\",\"type\":\"text/vnd.tiddlywiki\",\"text\":\"!! SyncAdaptor\\n\\nCopied and modified from Tiddlywiki core's `plugins/tiddlywiki/tiddlyweb/tiddlywebadaptor.js`.\\n\\nIt uses `src/services/wiki/ipcServerRoutes.ts` exposed from `window.wiki.ipcServerRoutes` to communicate with the main process.\\n\\nSome `JSON.stringify` and `JSON.parse` logic are removed, because we don't need this process when doing IPC. And some tiddlyweb related logic are removed, because it seems just transform to/back from tiddlyweb format, and nothing really changes after data received.\"},\"$:/plugins/linonetwo/expo-file-system-syncadaptor/tree\":{\"title\":\"$:/plugins/linonetwo/expo-file-system-syncadaptor/tree\",\"caption\":\"{{$:/language/SideBar/Explorer/Caption}}\",\"text\":\"<<tree \\\"$:/plugins/linonetwo/expo-file-system-syncadaptor/\\\">>\\n\"},\"$:/plugins/linonetwo/expo-file-system-syncadaptor/file-system-syncadaptor.js\":{\"title\":\"$:/plugins/linonetwo/expo-file-system-syncadaptor/file-system-syncadaptor.js\",\"type\":\"application/javascript\",\"module-type\":\"syncadaptor\",\"Modern.TiddlyDev#Origin\":\"file-system-syncadaptor.ts\",\"text\":\"\\\"use strict\\\";var _a,_b,__create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__esm=(e,i)=>function(){return i=e?(0,e[__getOwnPropNames(e)[0]])(e=0):i},__commonJS=(e,i)=>function(){return i||(0,e[__getOwnPropNames(e)[0]])((i={exports:{}}).exports,i),i.exports},__copyProps=(i,t,r,o)=>{if(t&&\\\"object\\\"==typeof t||\\\"function\\\"==typeof t)for(let e of __getOwnPropNames(t))__hasOwnProp.call(i,e)||e===r||__defProp(i,e,{get:()=>t[e],enumerable:!(o=__getOwnPropDesc(t,e))||o.enumerable});return i},__toESM=(e,i,t)=>(t=null!=e?__create(__getProtoOf(e)):{},__copyProps(!i&&e&&e.__esModule?t:__defProp(t,\\\"default\\\",{value:e,enumerable:!0}),e)),init_esbuild_inject=__esm({\\\"node_modules/.pnpm/tiddlywiki-plugin-dev@0.0.39_postcss@8.4.29_ts-node@10.9.1/node_modules/tiddlywiki-plugin-dev/dist/js/esbuild-inject.js\\\"(){}}),require_isObject=__commonJS({\\\"node_modules/lodash/isObject.js\\\"(e,i){init_esbuild_inject(),i.exports=function(e){var i=typeof e;return null!=e&&(\\\"object\\\"==i||\\\"function\\\"==i)}}}),require_freeGlobal=__commonJS({\\\"node_modules/lodash/_freeGlobal.js\\\"(e,i){init_esbuild_inject();var t=\\\"object\\\"==typeof global&&global&&global.Object===Object&&global;i.exports=t}}),require_root=__commonJS({\\\"node_modules/lodash/_root.js\\\"(e,i){init_esbuild_inject();var t=require_freeGlobal(),r=\\\"object\\\"==typeof self&&self&&self.Object===Object&&self,t=t||r||Function(\\\"return this\\\")();i.exports=t}}),require_now=__commonJS({\\\"node_modules/lodash/now.js\\\"(e,i){init_esbuild_inject();var t=require_root();i.exports=function(){return t.Date.now()}}}),require_trimmedEndIndex=__commonJS({\\\"node_modules/lodash/_trimmedEndIndex.js\\\"(e,i){init_esbuild_inject();var t=/\\\\s/;i.exports=function(e){for(var i=e.length;i--&&t.test(e.charAt(i)););return i}}}),require_baseTrim=__commonJS({\\\"node_modules/lodash/_baseTrim.js\\\"(e,i){init_esbuild_inject();var t=require_trimmedEndIndex(),r=/^\\\\s+/;i.exports=function(e){return e&&e.slice(0,t(e)+1).replace(r,\\\"\\\")}}}),require_Symbol=__commonJS({\\\"node_modules/lodash/_Symbol.js\\\"(e,i){init_esbuild_inject();var t=require_root().Symbol;i.exports=t}}),require_getRawTag=__commonJS({\\\"node_modules/lodash/_getRawTag.js\\\"(e,i){init_esbuild_inject();var t=require_Symbol(),r=Object.prototype,s=r.hasOwnProperty,d=r.toString,l=t?t.toStringTag:void 0;i.exports=function(e){var i=s.call(e,l),t=e[l];try{var r=!(e[l]=void 0)}catch(n){}var o=d.call(e);return r&&(i?e[l]=t:delete e[l]),o}}}),require_objectToString=__commonJS({\\\"node_modules/lodash/_objectToString.js\\\"(e,i){init_esbuild_inject();var t=Object.prototype.toString;i.exports=function(e){return t.call(e)}}}),require_baseGetTag=__commonJS({\\\"node_modules/lodash/_baseGetTag.js\\\"(e,i){init_esbuild_inject();var t=require_Symbol(),r=require_getRawTag(),o=require_objectToString(),n=t?t.toStringTag:void 0;i.exports=function(e){return null==e?void 0===e?\\\"[object Undefined]\\\":\\\"[object Null]\\\":(n&&n in Object(e)?r:o)(e)}}}),require_isObjectLike=__commonJS({\\\"node_modules/lodash/isObjectLike.js\\\"(e,i){init_esbuild_inject(),i.exports=function(e){return null!=e&&\\\"object\\\"==typeof e}}}),require_isSymbol=__commonJS({\\\"node_modules/lodash/isSymbol.js\\\"(e,i){init_esbuild_inject();var t=require_baseGetTag(),r=require_isObjectLike();i.exports=function(e){return\\\"symbol\\\"==typeof e||r(e)&&\\\"[object Symbol]\\\"==t(e)}}}),require_toNumber=__commonJS({\\\"node_modules/lodash/toNumber.js\\\"(e,i){init_esbuild_inject();var t=require_baseTrim(),r=require_isObject(),o=require_isSymbol(),n=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,d=/^0o[0-7]+$/i,l=parseInt;i.exports=function(e){if(\\\"number\\\"==typeof e)return e;if(o(e))return NaN;if(r(e)&&(i=\\\"function\\\"==typeof e.valueOf?e.valueOf():e,e=r(i)?i+\\\"\\\":i),\\\"string\\\"!=typeof e)return 0===e?e:+e;e=t(e);var i=s.test(e);return i||d.test(e)?l(e.slice(2),i?2:8):n.test(e)?NaN:+e}}}),require_debounce=__commonJS({\\\"node_modules/lodash/debounce.js\\\"(e,i){init_esbuild_inject();var v=require_isObject(),h=require_now(),S=require_toNumber(),y=Math.max,w=Math.min;i.exports=function(r,o,e){var n,s,t,d,l,a,u=0,c=!1,_=!1,i=!0;if(\\\"function\\\"!=typeof r)throw new TypeError(\\\"Expected a function\\\");function g(e){var i=n,t=s;return n=s=void 0,u=e,d=r.apply(t,i)}function m(e){var i=e-a;return void 0===a||o<=i||i<0||_&&t<=e-u}function f(){var e,i=h();if(m(i))return p(i);l=setTimeout(f,(i=o-((e=i)-a),_?w(i,t-(e-u)):i))}function p(e){return l=void 0,i&&n?g(e):(n=s=void 0,d)}function b(){var e,i=h(),t=m(i);if(n=arguments,s=this,a=i,t){if(void 0===l)return u=e=a,l=setTimeout(f,o),c?g(e):d;if(_)return clearTimeout(l),l=setTimeout(f,o),g(a)}return void 0===l&&(l=setTimeout(f,o)),d}return o=S(o)||0,v(e)&&(c=!!e.leading,_=\\\"maxWait\\\"in e,t=_?y(S(e.maxWait)||0,o):t,i=\\\"trailing\\\"in e?!!e.trailing:i),b.cancel=function(){void 0!==l&&clearTimeout(l),n=a=s=l=void(u=0)},b.flush=function(){return void 0===l?d:p(h())},b}}}),import_debounce=(init_esbuild_inject(),__toESM(require_debounce())),getFullSaveTiddlers=(init_esbuild_inject(),e=>[...null!=e&&e.startsWith(\\\"$:/\\\")?[e]:[]]),TidGiMobileFileSystemSyncAdaptor=class{constructor(e){var i;if(this.name=\\\"tidgi-mobile-fs\\\",this.supportsLazyLoading=!0,this.updatedTiddlers={modifications:[],deletions:[]},this.recentUpdatedTiddlersFromClient={modifications:[],deletions:[]},void 0===(null==(i=window.service)?void 0:i.wikiStorageService))throw new Error(\\\"TidGi-Mobile wikiStorageService is undefined, can't load wiki.\\\");if(this.wikiStorageService=window.service.wikiStorageService,void 0===(null==(i=window.meta)?void 0:i.workspaceID))throw new Error(\\\"TidGi-Mobile workspaceID is undefined, can't load wiki.\\\");this.workspaceID=window.meta.workspaceID,this.wiki=e.wiki,this.hasStatus=!1,this.isAnonymous=!1,this.logger=new $tw.utils.Logger(\\\"TidGiMobileFileSystemSyncAdaptor\\\"),this.isLoggedIn=!1,this.isReadOnly=!1,this.logoutIsAvailable=!0}setupSSE(){if(void 0===this.wikiStorageService.getWikiChangeObserver$)console.error(\\\"getWikiChangeObserver$ is undefined in wikiStorageService, can't subscribe to server changes.\\\");else{const e=(0,import_debounce[\\\"default\\\"])(()=>{void 0===$tw.syncer?console.error(\\\"Syncer is undefined in TidGiMobileFileSystemSyncAdaptor. Abort the `syncFromServer` in `setupSSE debouncedSync`.\\\"):($tw.syncer.syncFromServer(),this.clearUpdatedTiddlers())},500);this.logger.log(\\\"setupSSE\\\"),this.configSyncer(),this.wikiStorageService.getWikiChangeObserver$().subscribe(i=>{Object.keys(i).forEach(e=>{i[e]&&(i[e].deleted&&!this.recentUpdatedTiddlersFromClient.deletions.includes(e)?this.updatedTiddlers.deletions.push(e):i[e].modified&&!this.recentUpdatedTiddlersFromClient.modifications.includes(e)&&this.updatedTiddlers.modifications.push(e))}),e()})}}addRecentUpdatedTiddlersFromClient(i,t){this.recentUpdatedTiddlersFromClient[i].push(t),setTimeout(()=>{var e=this.recentUpdatedTiddlersFromClient[i].indexOf(t);-1!==e&&this.recentUpdatedTiddlersFromClient[i].splice(e,1)},2e3)}clearUpdatedTiddlers(){this.updatedTiddlers={modifications:[],deletions:[]}}configSyncer(){void 0===$tw.syncer?console.error(\\\"Syncer is undefined in TidGiMobileFileSystemSyncAdaptor. Abort the configSyncer.\\\"):$tw.syncer.pollTimerInterval=2147483647}getUpdatedTiddlers(e,i){this.logger.log(\\\"getUpdatedTiddlers\\\"),i(null,this.updatedTiddlers)}setLoggerSaveBuffer(e){this.logger.setSaveBuffer(e)}isReady(){return!0}getTiddlerInfo(e){return{bag:e.fields.bag}}getTiddlerRevision(e){var i=this.wiki.getTiddler(e);return null==(i=null==i?void 0:i.fields)?void 0:i.revision}async getStatus(e){var i;this.logger.log(\\\"Getting status\\\");try{var t=await this.wikiStorageService.getStatus();if(void 0===t)throw new Error(\\\"No status returned from callWikiIpcServerRoute getStatus\\\");this.hasStatus=!0,this.recipe=null==(i=t.space)?void 0:i.recipe,this.isLoggedIn=\\\"GUEST\\\"!==t.username,this.isReadOnly=!!t.read_only,this.isAnonymous=!!t.anonymous,null!=e&&e(null,this.isLoggedIn,t.username,this.isReadOnly,this.isAnonymous)}catch(r){null!=e&&e(r)}}async getSkinnyTiddlers(e){try{var i=await this.wikiStorageService.getSkinnyTiddlers();if(void 0===i)null!=e&&e(new Error(\\\"Load tiddler store failed\\\"));else{var t=JSON.parse(i);if(void 0===t)throw new Error(\\\"No tiddlers returned from callWikiIpcServerRoute getTiddlersJSON in getSkinnyTiddlers\\\");this.logger.log(\\\"skinnyTiddlers.length\\\",t.length),e(null,t)}}catch(r){null!=e&&e(r)}}async saveTiddler(e,i,t){if(this.isReadOnly)i(null);else try{var r,o=e.fields.title,n=(this.logger.log(\\\"saveTiddler \\\"+o),this.addRecentUpdatedTiddlersFromClient(\\\"modifications\\\",o),getFullSaveTiddlers(o).includes(o)),s=await this.wikiStorageService.saveTiddler(o,e.fields.text,n?JSON.stringify(e.getFieldStrings()):JSON.stringify({...e.getFieldStrings({exclude:[\\\"text\\\"]}),_is_skinny:\\\"\\\"}));void 0===s?i(new Error(\\\"Response from server is missing required `etag` header\\\")):void 0!==(r=this.parseEtag(s))&&i(null,{bag:r.bag},r.revision)}catch(d){null!=i&&i(d)}}async loadTiddler(e,i){var t;this.logger.log(\\\"loadTiddler \\\"+e);try{var r=await this.wikiStorageService.loadTiddlerText(e),o=this.wiki.getTiddler(e);if(void 0===o)throw new Error(`Tiddler \\\"${e}\\\" not exist`);if(void 0===r)throw new Error(`Tiddler \\\"${e}\\\" is not synced yet.`);var n={...o.fields,text:r,type:null!=(t=o.fields.type)?t:\\\"text/vnd.tiddlywiki\\\",bag:\\\"default\\\"};null!=i&&i(null,n)}catch(s){null!=i&&i(s)}}async deleteTiddler(e,i,t){if(this.isReadOnly)i(null);else{var r=null==(r=null==(r=null==t?void 0:t.tiddlerInfo)?void 0:r.adaptorInfo)?void 0:r.bag;if(this.logger.log(\\\"deleteTiddler\\\",r),r){this.addRecentUpdatedTiddlersFromClient(\\\"deletions\\\",e);r=await this.wikiStorageService.deleteTiddler(e);try{if(!r)throw new Error(\\\"getTiddler returned undefined from callWikiIpcServerRoute getTiddler in loadTiddler\\\");i(null,null)}catch(o){null!=i&&i(o)}}else i(null,t.tiddlerInfo.adaptorInfo)}}parseEtag(e){var i=e.indexOf(\\\"/\\\"),t=e.lastIndexOf(\\\"/\\\"),r=e.lastIndexOf(\\\":\\\");if(-1!==i&&-1!==t&&-1!==r)return{bag:$tw.utils.decodeURIComponentSafe(e.substring(1,i)),title:$tw.utils.decodeURIComponentSafe(e.substring(i+1,t)),revision:e.substring(t+1,r)}}};if($tw.browser&&\\\"undefined\\\"!=typeof window){const Nb=\\\"undefined\\\"!=typeof document&&window.isInTidGi,Ob=Boolean(null==(_a=window.service)?void 0:_a.wikiStorageService),Pb=Boolean(null==(_b=window.meta)?void 0:_b.workspaceID);Nb&&Ob&&Pb&&(exports.adaptorClass=TidGiMobileFileSystemSyncAdaptor)}\"},\"$:/plugins/linonetwo/expo-file-system-syncadaptor/fix-location-info.js\":{\"title\":\"$:/plugins/linonetwo/expo-file-system-syncadaptor/fix-location-info.js\",\"type\":\"application/javascript\",\"module-type\":\"info\",\"Modern.TiddlyDev#Origin\":\"fix-location-info.ts\",\"text\":\"\\\"use strict\\\";function getInfoTiddlerFields(e){var t,i,n=function(e){return e?\\\"yes\\\":\\\"no\\\"},d=[];return $tw.browser&&\\\"undefined\\\"!=typeof window&&(t=\\\"undefined\\\"!=typeof document,i=null==(i=window.meta)?void 0:i.workspaceID,d.push({title:\\\"$:/info/tidgi\\\",text:n(t)},{title:\\\"$:/info/tidgi-mobile\\\",text:n(t)}),t)&&i&&d.push({title:\\\"$:/info/tidgi/workspaceID\\\",text:i}),d}exports.getInfoTiddlerFields=getInfoTiddlerFields;\"}}}","title":"$:/plugins/linonetwo/expo-file-system-syncadaptor","type":"application/json","version":"0.1.0","Modern.TiddlyDev#SHA256-Hashed":"186dfb3fd77f3482a8a0dbb1790b8f7c2e245497fd5cbfac1e75058cd63d1a9f"}